<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pet Adoption Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    
    <style>
        .off-white-bg {
            background-color: #E6E6E6FF !important;
        }
        
        @media (min-width: 768px) {
            .fixed-sidebar {
                position: fixed;
                top: 0;
                bottom: 0;
                width: 16.66666667%; 
                overflow-y: auto; 
            }
        }

        .main-content {
            margin-left: 16.66666667%;
        }
        
        .mobile-toggler {
            background-color: transparent !important;
            border: none !important;
            color: #333 !important;
        }
        .mobile-toggler:hover {
            opacity: 0.7;
        }
        
        .off-white-bg h4, .off-white-bg .nav-link {
            color: #333333 !important;
        }
        .off-white-bg .nav-link.active {
            color: #4B52D7FF !important;
            background-color: #D1D2F0FF !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="d-md-none p-3 border-bottom off-white-bg d-flex justify-content-between align-items-center">
            <button class="btn mobile-toggler" type="button" 
                data-bs-toggle="offcanvas" 
                data-bs-target="#sidebarOffcanvas" 
                aria-controls="sidebarOffcanvas">
                â˜°
            </button>
            {% if session.user_name %}
            <div class="text-end">
                <small class="text-muted d-block">{{ session.user_name }}</small>
                <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger">Logout</a>
            </div>
            {% endif %}
        </div>
        
        <div class="row">
            
            <nav class="col-md-2 py-4 offcanvas-md offcanvas-start fixed-sidebar off-white-bg" 
                 tabindex="-1" 
                 id="sidebarOffcanvas" 
                 aria-labelledby="sidebarOffcanvasLabel"
                 data-bs-scroll="true">
                
                <div class="offcanvas-header d-md-none">
                    <h5 class="offcanvas-title" id="sidebarOffcanvasLabel"></h5>
                    <button type="button" class="btn-close" 
                            data-bs-dismiss="offcanvas" aria-label="Close"></button>
                </div>
                
                <div class="offcanvas-body d-md-block">
                    
                    <h4 class="text-center mb-4">Navigation</h4>
                    
                    {% if session.user_name %}
                    <div class="mb-3 p-2 text-center border-bottom">
                        <small class="text-muted d-block">Logged in as:</small>
                        <strong>{{ session.user_name }}</strong>
                        <br>
                        <small class="text-muted">{{ session.user_role|title }}</small>
                    </div>
                    {% endif %}
                    
                    <div class="nav flex-column">
                        {% if nav_options %}
                            {% for label, endpoint in nav_options.items() %}
                            <a class="nav-link {% if current_page == endpoint %}active{% endif %}"
                            href="{% if endpoint == 'dashboard' %}{{ url_for('render_page', page_name='dashboard') }}{% else %}{{ url_for('render_page', page_name=endpoint) }}{% endif %}">
                            {{ label }}
                            </a>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted small text-center">Please login to access navigation</p>
                        {% endif %}
                    </div>
                    
                    {% if session.user_id %}
                    <div class="mt-3 pt-3 border-top">
                        <a href="{{ url_for('logout') }}" class="btn btn-sm btn-outline-danger w-100">Logout</a>
                    </div>
                    {% endif %}
                </div>
            </nav>
            
            <main class="col-md-10 ms-sm-auto col-lg-10 px-md-4 main-content">
                <div class="mb-2 mt-2">
                    <small id="last-refresh-time" class="text-muted">Last updated: <span id="refresh-time-display">Loading...</span></small>
                </div>
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Auto-refresh mechanism to keep pages updated with latest database changes
        (function() {
            let lastRefreshTime = new Date();
            const REFRESH_INTERVAL = 30000; // 30 seconds
            let refreshTimer = null;
            let isPageVisible = true;
            
            // Update last refresh time display
            function updateRefreshTime() {
                const refreshIndicator = document.getElementById('last-refresh-time');
                if (refreshIndicator) {
                    lastRefreshTime = new Date();
                    const timeDisplay = document.getElementById('refresh-time-display');
                    if (timeDisplay) {
                        timeDisplay.textContent = lastRefreshTime.toLocaleTimeString();
                    }
                    if (refreshIndicator) {
                        refreshIndicator.innerHTML = 'Last updated: <span id="refresh-time-display">' + lastRefreshTime.toLocaleTimeString() + '</span>';
                    }
                }
            }
            
            // Refresh the current page
            function refreshPage() {
                if (isPageVisible && !document.hidden) {
                    // Don't refresh if user is actively interacting with forms
                    const activeForm = document.querySelector('form:not([data-no-refresh]) input:focus, form:not([data-no-refresh]) textarea:focus, form:not([data-no-refresh]) select:focus');
                    const hasActiveForm = document.querySelector('form:not([data-no-refresh])') && !activeForm;
                    
                    // Only refresh if not on login/register pages and no active form interaction
                    const currentUrl = window.location.href;
                    if (!currentUrl.includes('/login') && !currentUrl.includes('/register') && !activeForm) {
                        // Use location.reload() to get fresh data
                        window.location.reload();
                    }
                }
            }
            
            // Handle page visibility changes
            document.addEventListener('visibilitychange', function() {
                isPageVisible = !document.hidden;
                if (isPageVisible) {
                    // Refresh when page becomes visible again
                    refreshPage();
                    updateRefreshTime();
                }
            });
            
            // Refresh on window focus
            window.addEventListener('focus', function() {
                refreshPage();
                updateRefreshTime();
            });
            
            // Set up periodic refresh
            function startAutoRefresh() {
                if (refreshTimer) clearInterval(refreshTimer);
                refreshTimer = setInterval(function() {
                    if (isPageVisible && !document.hidden) {
                        refreshPage();
                    }
                }, REFRESH_INTERVAL);
            }
            
            // Initialize on page load
            function initialize() {
                updateRefreshTime();
                startAutoRefresh();
            }
            
            // Start auto-refresh when page loads
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initialize);
            } else {
                initialize();
            }
            
            // Prevent refresh during form submission and while user is typing
            document.addEventListener('submit', function(e) {
                const form = e.target;
                if (form.tagName === 'FORM') {
                    form.setAttribute('data-no-refresh', 'true');
                    if (refreshTimer) {
                        clearInterval(refreshTimer);
                    }
                    // Resume after a delay to allow form processing
                    setTimeout(startAutoRefresh, 10000);
                }
            });
            
            // Pause refresh when user is typing in any input
            let typingTimer = null;
            document.addEventListener('input', function() {
                if (refreshTimer) {
                    clearInterval(refreshTimer);
                }
                clearTimeout(typingTimer);
                typingTimer = setTimeout(function() {
                    startAutoRefresh();
                }, 5000); // Resume 5 seconds after user stops typing
            });
        })();
    </script>
</body>
</html>